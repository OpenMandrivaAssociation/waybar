From 25cd5ea8fe4a2b76242fe3fedf1e1cc5ab7c7a4d Mon Sep 17 00:00:00 2001
From: Ryan Walklin <ryan@testtoast.com>
Date: Thu, 15 Feb 2024 09:37:36 +1300
Subject: [PATCH] Update Wireplumber API to 0.5

---
 include/modules/wireplumber.hpp |  4 ++++
 meson.build                     |  2 +-
 src/modules/wireplumber.cpp     | 14 +++++---------
 3 files changed, 10 insertions(+), 10 deletions(-)

diff --git a/include/modules/wireplumber.hpp b/include/modules/wireplumber.hpp
index 9bbf4d464..25d411c57 100644
--- a/include/modules/wireplumber.hpp
+++ b/include/modules/wireplumber.hpp
@@ -1,8 +1,12 @@
 #pragma once
 
+
 #include <fmt/format.h>
 #include <wp/wp.h>
 
+#define WP_LOCAL_LOG_TOPIC wp_waybar
+WP_LOG_TOPIC_EXTERN (wp_waybar)
+
 #include <algorithm>
 #include <array>
 
diff --git a/meson.build b/meson.build
index d75497316..485752408 100644
--- a/meson.build
+++ b/meson.build
@@ -106,7 +106,7 @@ libevdev = dependency('libevdev', required: get_option('libevdev'))
 libmpdclient = dependency('libmpdclient', required: get_option('mpd'))
 xkbregistry = dependency('xkbregistry')
 libjack = dependency('jack', required: get_option('jack'))
-libwireplumber = dependency('wireplumber-0.4', required: get_option('wireplumber'))
+libwireplumber = dependency('wireplumber-0.5', required: get_option('wireplumber'))
 
 libsndio = compiler.find_library('sndio', required: get_option('sndio'))
 if libsndio.found()
diff --git a/src/modules/wireplumber.cpp b/src/modules/wireplumber.cpp
index 51bb708d1..451935f2d 100644
--- a/src/modules/wireplumber.cpp
+++ b/src/modules/wireplumber.cpp
@@ -17,7 +17,7 @@ waybar::modules::Wireplumber::Wireplumber(const std::string& id, const Json::Val
       volume_(0.0),
       min_step_(0.0),
       node_id_(0) {
-  wp_init(WP_INIT_PIPEWIRE);
+  wp_init(WP_INIT_ALL);
   wp_core_ = wp_core_new(NULL, NULL);
   apis_ = g_ptr_array_new_with_free_func(g_object_unref);
   om_ = wp_object_manager_new();
@@ -255,15 +255,11 @@ void waybar::modules::Wireplumber::loadRequiredApiModules() {
   spdlog::debug("[{}]: loading required modules", name_);
   g_autoptr(GError) error = NULL;
 
-  if (!wp_core_load_component(wp_core_, "libwireplumber-module-default-nodes-api", "module", NULL,
-                              &error)) {
-    throw std::runtime_error(error->message);
-  }
+  wp_core_load_component(wp_core_, "libwireplumber-module-default-nodes-api", "module", NULL,
+                              NULL, NULL, NULL, nullptr);
 
-  if (!wp_core_load_component(wp_core_, "libwireplumber-module-mixer-api", "module", NULL,
-                              &error)) {
-    throw std::runtime_error(error->message);
-  }
+  wp_core_load_component(wp_core_, "libwireplumber-module-mixer-api", "module", NULL,
+                              NULL, NULL, NULL, nullptr);
 
   g_ptr_array_add(apis_, wp_plugin_find(wp_core_, "default-nodes-api"));
   g_ptr_array_add(apis_, ({
