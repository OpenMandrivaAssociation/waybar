From c0d84853ea2f3f8b016abf92458ba15378de6c91 Mon Sep 17 00:00:00 2001
From: Aleksei Bavshin <alebastr89@gmail.com>
Date: Fri, 7 Jan 2022 18:09:44 -0800
Subject: [PATCH 1/6] refactor(clock): extract waybar_time to
 util/waybar_time.hpp

---
 include/modules/clock.hpp    | 18 ++++++------------
 include/util/waybar_time.hpp | 29 +++++++++++++++++++++++++++++
 src/modules/clock.cpp        | 14 ++------------
 3 files changed, 37 insertions(+), 24 deletions(-)
 create mode 100644 include/util/waybar_time.hpp

diff --git a/include/modules/clock.hpp b/include/modules/clock.hpp
index 9f950192..ddcdf609 100644
--- a/include/modules/clock.hpp
+++ b/include/modules/clock.hpp
@@ -1,21 +1,14 @@
 #pragma once
 
-#include <fmt/format.h>
-#if FMT_VERSION < 60000
-#include <fmt/time.h>
-#else
-#include <fmt/chrono.h>
-#endif
 #include <date/tz.h>
 #include "ALabel.hpp"
 #include "util/sleeper_thread.hpp"
 
-namespace waybar::modules {
+namespace waybar {
 
-struct waybar_time {
-  std::locale locale;
-  date::zoned_seconds ztime;
-};
+struct waybar_time;
+
+namespace modules {
 
 const std::string kCalendarPlaceholder = "calendar";
 
@@ -43,4 +36,5 @@ class Clock : public ALabel {
   bool is_timezone_fixed();
 };
 
-}  // namespace waybar::modules
+}  // namespace modules
+}  // namespace waybar
diff --git a/include/util/waybar_time.hpp b/include/util/waybar_time.hpp
new file mode 100644
index 00000000..3eaf1146
--- /dev/null
+++ b/include/util/waybar_time.hpp
@@ -0,0 +1,29 @@
+#pragma once
+
+#include <fmt/format.h>
+#if FMT_VERSION < 60000
+#include <fmt/time.h>
+#else
+#include <fmt/chrono.h>
+#endif
+#include <date/tz.h>
+
+namespace waybar {
+
+struct waybar_time {
+  std::locale         locale;
+  date::zoned_seconds ztime;
+};
+
+}  // namespace waybar
+
+template <>
+struct fmt::formatter<waybar::waybar_time> : fmt::formatter<std::tm> {
+  template <typename FormatContext>
+  auto format(const waybar::waybar_time& t, FormatContext& ctx) {
+#if FMT_VERSION >= 80000
+    auto& tm_format = specs;
+#endif
+    return format_to(ctx.out(), "{}", date::format(t.locale, fmt::to_string(tm_format), t.ztime));
+  }
+};
diff --git a/src/modules/clock.cpp b/src/modules/clock.cpp
index 7e7d7420..739b79d1 100644
--- a/src/modules/clock.cpp
+++ b/src/modules/clock.cpp
@@ -6,12 +6,13 @@
 #include <sstream>
 #include <type_traits>
 #include "util/ustring_clen.hpp"
+#include "util/waybar_time.hpp"
 #ifdef HAVE_LANGINFO_1STDAY
 #include <langinfo.h>
 #include <locale.h>
 #endif
 
-using waybar::modules::waybar_time;
+using waybar::waybar_time;
 
 waybar::modules::Clock::Clock(const std::string& id, const Json::Value& config)
     : ALabel(config, "clock", id, "{:%H:%M}", 60, false, false, true),
@@ -227,14 +228,3 @@ auto waybar::modules::Clock::first_day_of_week() -> date::weekday {
 #endif
   return date::Sunday;
 }
-
-template <>
-struct fmt::formatter<waybar_time> : fmt::formatter<std::tm> {
-  template <typename FormatContext>
-  auto format(const waybar_time& t, FormatContext& ctx) {
-#if FMT_VERSION >= 80000
-	auto& tm_format = specs;
-#endif
-    return format_to(ctx.out(), "{}", date::format(t.locale, fmt::to_string(tm_format), t.ztime));
-  }
-};


From 1489a539f85a177d5efe78a292fabfe9758a2f48 Mon Sep 17 00:00:00 2001
From: Aleksei Bavshin <alebastr89@gmail.com>
Date: Fri, 7 Jan 2022 22:09:46 -0800
Subject: [PATCH 4/6] chore: bump supported fmt ver to 7.0.0

Certain features we use were added only in 7.0 and the code no longer
compiles with any earlier versions.
---
 meson.build | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/meson.build b/meson.build
index 2c434266..1ccf6340 100644
--- a/meson.build
+++ b/meson.build
@@ -79,7 +79,7 @@ is_netbsd = host_machine.system() == 'netbsd'
 is_openbsd = host_machine.system() == 'openbsd'
 
 thread_dep = dependency('threads')
-fmt = dependency('fmt', version : ['>=5.3.0'], fallback : ['fmt', 'fmt_dep'])
+fmt = dependency('fmt', version : ['>=7.0.0'], fallback : ['fmt', 'fmt_dep'])
 spdlog = dependency('spdlog', version : ['>=1.8.5'], fallback : ['spdlog', 'spdlog_dep'], default_options : ['external_fmt=true'])
 wayland_client = dependency('wayland-client')
 wayland_cursor = dependency('wayland-cursor')

From 7f6bef20496ca23e83692801f6ff2957d28dde76 Mon Sep 17 00:00:00 2001
From: Aleksei Bavshin <alebastr89@gmail.com>
Date: Fri, 7 Jan 2022 22:25:15 -0800
Subject: [PATCH 5/6] fix(util): make waybar_time formatter compatible with fmt
 8.1.0

Stop using private implementation details of the `formatter<std::tm>`.
We never needed anything from the class besides the format specifier,
which is easily obtainable with public API.
---
 include/util/waybar_time.hpp | 32 +++++++++++++++++++++-----------
 src/modules/clock.cpp        |  8 +++++++-
 2 files changed, 28 insertions(+), 12 deletions(-)

diff --git a/include/util/waybar_time.hpp b/include/util/waybar_time.hpp
index 3eaf1146..c74e58c3 100644
--- a/include/util/waybar_time.hpp
+++ b/include/util/waybar_time.hpp
@@ -1,12 +1,7 @@
 #pragma once
 
-#include <fmt/format.h>
-#if FMT_VERSION < 60000
-#include <fmt/time.h>
-#else
-#include <fmt/chrono.h>
-#endif
 #include <date/tz.h>
+#include <fmt/format.h>
 
 namespace waybar {
 
@@ -18,12 +13,27 @@ struct waybar_time {
 }  // namespace waybar
 
 template <>
-struct fmt::formatter<waybar::waybar_time> : fmt::formatter<std::tm> {
+struct fmt::formatter<waybar::waybar_time> {
+  std::string_view specs;
+
+  template <typename ParseContext>
+  constexpr auto parse(ParseContext& ctx) -> decltype(ctx.begin()) {
+    auto it = ctx.begin();
+    if (it != ctx.end() && *it == ':') {
+      ++it;
+    }
+    auto end = it;
+    while (end != ctx.end() && *end != '}') {
+      ++end;
+    }
+    if (end != it) {
+      specs = {it, std::string_view::size_type(end - it)};
+    }
+    return end;
+  }
+
   template <typename FormatContext>
   auto format(const waybar::waybar_time& t, FormatContext& ctx) {
-#if FMT_VERSION >= 80000
-    auto& tm_format = specs;
-#endif
-    return format_to(ctx.out(), "{}", date::format(t.locale, fmt::to_string(tm_format), t.ztime));
+    return format_to(ctx.out(), "{}", date::format(t.locale, fmt::to_string(specs), t.ztime));
   }
 };
diff --git a/src/modules/clock.cpp b/src/modules/clock.cpp
index 739b79d1..b0a6776a 100644
--- a/src/modules/clock.cpp
+++ b/src/modules/clock.cpp
@@ -1,10 +1,16 @@
 #include "modules/clock.hpp"
 
-#include <time.h>
 #include <spdlog/spdlog.h>
+#if FMT_VERSION < 60000
+#include <fmt/time.h>
+#else
+#include <fmt/chrono.h>
+#endif
 
+#include <ctime>
 #include <sstream>
 #include <type_traits>
+
 #include "util/ustring_clen.hpp"
 #include "util/waybar_time.hpp"
 #ifdef HAVE_LANGINFO_1STDAY

From ce404199de0fb6cea8ff59cb8546c6669949a311 Mon Sep 17 00:00:00 2001
From: Aleksei Bavshin <alebastr89@gmail.com>
Date: Fri, 7 Jan 2022 22:50:23 -0800
Subject: [PATCH 6/6] chore: add `tzdata` to the alpine builder

Fixes date formatting test execution on alpine.
---
 Dockerfiles/alpine | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/Dockerfiles/alpine b/Dockerfiles/alpine
index c0e032ff..03836aaa 100644
--- a/Dockerfiles/alpine
+++ b/Dockerfiles/alpine
@@ -2,4 +2,4 @@
 
 FROM alpine:latest
 
-RUN apk add --no-cache git meson alpine-sdk libinput-dev wayland-dev wayland-protocols mesa-dev libxkbcommon-dev eudev-dev pixman-dev gtkmm3-dev jsoncpp-dev pugixml-dev libnl3-dev pulseaudio-dev libmpdclient-dev sndio-dev scdoc libxkbcommon
+RUN apk add --no-cache git meson alpine-sdk libinput-dev wayland-dev wayland-protocols mesa-dev libxkbcommon-dev eudev-dev pixman-dev gtkmm3-dev jsoncpp-dev pugixml-dev libnl3-dev pulseaudio-dev libmpdclient-dev sndio-dev scdoc libxkbcommon tzdata
